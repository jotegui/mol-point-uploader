{% extends "base.html" %}
{% block content %}

<div class="container">
    
    <div class="row">
        <button class="btn btn-default" onclick="window.location.replace('/datasets')">Back</button>
    </div>
    
    <div class="row">
        <div class="col-xs-6">
            <h2>{{ title }}</h2>
        </div>
        
        {% if entries %}
        
        <div class="col-xs-6">
            <div class="btn-toolbar pull-right" role="toolbar">
                
                <!-- all/species toggle -->
                <div id="speciesbuttons" class="btn-group" role="group">
                    <input type="button" id="allspeciesfield" class="btn btn-primary" disabled value="All species">

                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-expanded="false" value="Single species">
                            <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu" role="menu">
                            <li><a id="allspecies">All species</a></li>
                            {% for i in species %}
                            <li><a id="{{i|replace(" ", "_")}}">{{ i }}</a></li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
        
                <!-- list/map switch -->
                <div role="group" class="btn-group" data-toggle="buttons">
                    <label class="btn btn-primary active" onclick="$('#mapPanel').show(); $('#listPanel').hide(); $('#speciesbuttons').show();">
                        <input type="radio" name="view" id="mapView" autocomplete="off">Map
                    </label>
                    <label class="btn btn-primary" onclick="$('#mapPanel').hide(); $('#listPanel').show(); $('#speciesbuttons').hide();">
                        <input type="radio" name="view" id="listView" autocomplete="off" checked>List
                    </label>
                </div>

            </div>
        </div>
        {% endif %}
        
    </div>

{% if entries %}
        
    <div id="listPanel" hidden>

        <table class="table table-striped table-bordered table-hover" id="recordsTable" data-sort-name="scientificname">
            <thead>
                <tr>
                    <th>ID</th>
                    <th data-field="scientificname" data-sortable="true">Scientific Name</th>
                    <th>Coordinates</th>
                    <th>Datum</th>
                    <th>Uncertainty</th>
                    <th>Event Date</th>
                    <th>Recorded By</th>
                    {% for extra in entries[0]['extrafields'] %}
                    <th>{{ extra }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td>{{ entry.cartodb_id }}</td>
                    <td>{{ entry.scientificname }}</td>
                    <td>{{ entry.decimallatitude }}, {{ entry.decimallongitude }}</td>
                    <td>{{ entry.geodeticdatum }}</td>
                    <td>{{ entry.coordinateuncertaintyinmeters }}</td>
                    <td>{{ entry.eventdate }}</td>
                    <td>{{ entry.recordedby }}</td>
                    {% for extra in entry['extrafields'] %}
                    <td>{{ entry.extrafields[extra] }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
    </div>
    
    <div id="mapPanel" class="active">
        <style>
            #map_canvas {height: 650px; z-index: -1;}
            .legend {
                line-height: 18px;
                color: #555;
                background-color: #FFF;
                opacity: 0.8;
            }
            .legend i {
                width: 18px;
                height: 18px;
                float: left;
                margin-right: 8px;
                opacity: 0.7;
            }
        </style>
        <div id="map_canvas" class="well"></div>
        
        <script>

            var stringToColour = function(str) {
                // str to hash
                for (var i = 0, hash = 0; i < str.length; hash = str.charCodeAt(i++) + ((hash << 5) - hash));
                // int/hash to hex
                for (var i = 0, colour = "#"; i < 3; colour += ("00" + ((hash >> i++ * 8) & 0xFF).toString(16)).slice(-2));
                return colour;
            }
            
            var createMapConfig = function(species) {
                var layers = [];
                
                for (var i=0; i<species.length; i++) {
                    layers[i] = {
                        "type": "cartodb",
                        "options": {
                          "cartocss_version": "2.1.1",
                          "cartocss": "#layer{marker-fill: "+stringToColour(species[i])+"; marker-width: 5; marker-line-color: gray; marker-line-width: 0.5;}",
                          "sql": "select * from point_uploads where datasetid='{{ datasetid }}' and scientificname='"+species[i]+"'"
                        }
                      }
                }
                
                var mapconfig = {
                  "version": "1.0.1",
                  "layers": layers
                }
                return mapconfig;
            }
            
            function getColor(d) {
                for (var i=0; i<species.length; i++) {
                    if (d==species[i]) {
                        var color = stringToColour(species[i])
                    }
                }
                return color
            }

            
            function createLegend(map, species) {
                var legend = L.control({position: 'topright'});
                
                legend.onAdd = function (map) {

                    var div = L.DomUtil.create('div', 'info legend'),
                        grades = [],
                        labels = species;

                    // loop through our density intervals and generate a label with a colored square for each interval
                    for (var i = 0; i < labels.length; i++) {
                        div.innerHTML +=
                            '<i style="background:' + getColor(labels[i]) + '"></i> ' + labels[i] + '&nbsp <br>';
                    }

                    return div;
                };

                legend.addTo(map);
            }
            
            var createMap = function(species) {
                
                // create map
                var map = new L.map('map_canvas').setView({{centroid}}, 3);
                
                // add base layer
                L.tileLayer('https://dnv9my2eseobd.cloudfront.net/v3/cartodb.map-4xtxp73f/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    attribution: '&copy; <a href="http://www.mol.org">Map of Life</a>, 2014'
                }).addTo(map);
                
                // define mapconfig for ad-hoc anonymous map
                var mapconfig = createMapConfig(species);
                
                // initialize and attach ad-hoc map
                $.ajax({
                  type: 'POST',
                  dataType: 'json',
                  contentType: 'application/json',
                  url: 'http://mol.cartodb.com/api/v1/map',
                  data: JSON.stringify(mapconfig),
                  success: function(data) {
                    var templateUrl = 'http://mol.cartodb.com/api/v1/map/' + data.layergroupid + '/{z}/{x}/{y}.png'
                    L.tileLayer(templateUrl, {
                        maxZoom: 18
                    }).addTo(map)
                  }
                });

                createLegend(map, species);
                
                return map;
            }
            
            var resetMap = function(map, species) {
                map.remove();
                var map = createMap(species);
                return map;
            }
            
            {% for i in species %}
            $('#{{i|replace(" ", "_")}}').click(function() {
                species = ['{{i}}'];
                $("#allspeciesfield").val('{{i}}');
                map = resetMap(map, species);
                $('#allspecies').removeClass('active');
                return map;
            });
            {% endfor %}
            
            $('#allspecies').click(function() {
                species = [
                    {% for i in species %}'{{ i }}',
                    {% endfor %}
                ];
                $("#allspeciesfield").val('All species');
                map = resetMap(map, species);
            });
            
            
            species = [
                {% for i in species %}'{{ i }}',
                {% endfor %}
            ];
            
            var map = createMap(species);

        </script>

    </div>

{% else %}

    <div>
        <p>No map available</p>
    </div>

{% endif %}
<script>
$(document).ready(function() {
    $('#recordsTable').dataTable();
} );
</script>
</div>

{% endblock %}
