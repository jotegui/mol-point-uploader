{% extends "base.html" %}
{% block content %}

<div class="container">

    <div class="row">
        <div class="col-xs-8">
            <h2>Data on {{ title }}</h2>
        </div>
        
        {% if entries and layergroupid%}
        <div class="col-xs-4">
            <div class="btn-group pull-right" data-toggle="buttons">
                {% if entries %}
                <label class="btn btn-primary" onclick="$('#mapPanel').hide(); $('#listPanel').show();">
                    <input type="radio" name="view" id="listView" autocomplete="off" checked>List
                </label>
                {% endif %}
                {% if layergroupid %}
                <label class="btn btn-primary active" onclick="$('#mapPanel').show(); $('#listPanel').hide();">
                    <input type="radio" name="view" id="mapView" autocomplete="off">Map
                </label>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
    
    <div class="" id="listPanel" hidden>
        {% if entries %}
        <table class="table table-striped table-bordered table-hover">
            <thead>
                <tr>
                    <th></th>
                    <th>ID</th>
                    <th>Scientific Name</th>
                    <th>Coordinates</th>
                    <th>Datum</th>
                    <th>Uncertainty</th>
                    <th>Event Date</th>
                    <th>Recorded By</th>
                    {% for extra in entries[0]['extrafields'] %}
                    <th>{{ extra }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for entry in entries %}
                <tr>
                    <td><input type="checkbox" name="chk" value="{{ entry.cartodb_id }}" id="chk_{{ entry.cartodb_id }}" /></td>
                    <td>{{ entry.cartodb_id }}</td>
                    <td>{{ entry.scientificname }}</td>
                    <td>{{ entry.decimallatitude }}, {{ entry.decimallongitude }}</td>
                    <td>{{ entry.geodeticdatum }}</td>
                    <td>{{ entry.coordinateuncertaintyinmeters }}</td>
                    <td>{{ entry.eventdate }}</td>
                    <td>{{ entry.recordedby }}</td>
                    {% for extra in entry['extrafields'] %}
                    <td>{{ entry.extrafields[extra] }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>No records available</p>
        {% endif %}
    </div>
    
    <div id="mapPanel" class="active">
        {% if layergroupid %}
        
        <div id="map" class="well"></div>
        {{centroid}}
        <script>
            $(window).load(function () {

                var map = L.map('map').setView({{centroid}}, 3);

                L.tileLayer('https://dnv9my2eseobd.cloudfront.net/v3/cartodb.map-4xtxp73f/{z}/{x}/{y}.png', {
                    maxZoom: 18
                }).addTo(map);

                var mapconfig = {
                  "version": "1.0.1",
                  "layers": [{
                    "type": "cartodb",
                    "options": {
                      "cartocss_version": "2.1.1",
                      "cartocss": "#layer{marker-fill: #109DCD; marker-width: 5; marker-line-color: white; marker-line-width: 0;}",
                      "sql": "select * from point_uploads where datasetid='{{datasetid}}'"
                    }
                  }]
                }

                $.ajax({
                  type: 'POST',
                  dataType: 'json',
                  contentType: 'application/json',
                  url: 'http://mol.cartodb.com/api/v1/map',
                  data: JSON.stringify(mapconfig),
                  success: function(data) {
                    var templateUrl = 'http://mol.cartodb.com/api/v1/map/' + data.layergroupid + '/{z}/{x}/{y}.png'
                    L.tileLayer(templateUrl, {
                        maxZoom: 18
                    }).addTo(map);
                  }
                })
            });
        </script>
        
        {% else %}
        <p>No map available</p>
        {% endif %}
    </div>
    
    <button class="btn btn-default" onclick="window.location.replace('/datasets')">Back</button>
</div>

{% endblock %}
